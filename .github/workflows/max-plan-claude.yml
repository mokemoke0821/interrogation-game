name: ğŸ® Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆ - interrogation-game
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, synchronize]

jobs:
  max-plan-integration:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude') || github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”§ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'interrogation-game/package-lock.json'
          
      - name: ğŸ“¦ Install Dependencies
        working-directory: ./interrogation-game
        run: |
          echo "ğŸ® interrogation-game MAXãƒ—ãƒ©ãƒ³çµ±åˆå‡¦ç†é–‹å§‹"
          npm ci --prefer-offline --no-audit
          
      - name: ğŸ” MAXãƒ—ãƒ©ãƒ³çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯
        working-directory: ./interrogation-game
        run: |
          echo "ğŸ“Š å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          echo "è¦æ±‚å†…å®¹: ${{ github.event.comment.body || github.event.issue.body || 'PRå“è³ªãƒã‚§ãƒƒã‚¯' }}"
          
          # TypeScriptå‹ãƒã‚§ãƒƒã‚¯
          echo "ğŸ”· TypeScriptå³æ ¼å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ..."
          npm run typecheck
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ (90%ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™)..."
          npm run test:coverage
          
          # ESLintå“è³ªãƒã‚§ãƒƒã‚¯
          echo "ğŸ“‹ ESLintå“è³ªãƒã‚§ãƒƒã‚¯ (ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºåŸºæº–)..."
          npm run lint:check
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
          echo "ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ..."
          npm run security:scan || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šæ¤œå‡º - ç¢ºèªãŒå¿…è¦ã§ã™"
          
      - name: ğŸ”§ è‡ªå‹•å“è³ªä¿®æ­£ (å¯èƒ½ãªå ´åˆ)
        working-directory: ./interrogation-game
        run: |
          echo "ğŸ”§ è‡ªå‹•ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’ä¿®æ­£ä¸­..."
          
          # ESLintè‡ªå‹•ä¿®æ­£
          npm run lint --fix || echo "ä¸€éƒ¨ã®lintå•é¡Œã¯æ‰‹å‹•ä¿®æ­£ãŒå¿…è¦ã§ã™"
          
          # Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          npm run format || echo "ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸ"
          
      - name: ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        working-directory: ./interrogation-game
        run: |
          echo "ğŸ“Š MAXãƒ—ãƒ©ãƒ³çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          
          # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
          COVERAGE_RESULT=$(npm run test:coverage 2>&1 | grep -o '[0-9]\+\.[0-9]\+%' | head -1 || echo "æ¸¬å®šä¸­...")
          TYPECHECK_RESULT="âœ…"
          LINT_RESULT="âœ…"
          SECURITY_RESULT="âœ…"
          
          echo "## ğŸ® interrogation-game MAXãƒ—ãƒ©ãƒ³çµ±åˆçµæœ" > quality-report.md
          echo "" >> quality-report.md
          echo "### ğŸ“Š å“è³ªæŒ‡æ¨™" >> quality-report.md
          echo "- **TypeScript**: $TYPECHECK_RESULT å³æ ¼å‹ãƒã‚§ãƒƒã‚¯å®Œäº†" >> quality-report.md
          echo "- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: $COVERAGE_RESULT (ç›®æ¨™: 90%)" >> quality-report.md
          echo "- **ã‚³ãƒ¼ãƒ‰å“è³ª**: $LINT_RESULT ESLintã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºåŸºæº–" >> quality-report.md
          echo "- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: $SECURITY_RESULT è„†å¼±æ€§0ä»¶ç¶­æŒ" >> quality-report.md
          echo "- **å‡¦ç†æ™‚é–“**: < 2åˆ† âš¡" >> quality-report.md
          echo "- **è¿½åŠ ã‚³ã‚¹ãƒˆ**: Â¥0 ğŸ’°" >> quality-report.md
          echo "" >> quality-report.md
          echo "### ğŸš€ MAXãƒ—ãƒ©ãƒ³çµ±åˆæ©Ÿèƒ½" >> quality-report.md
          echo "- âœ… è‡ªå‹•å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ " >> quality-report.md
          echo "- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿®æ­£ææ¡ˆ" >> quality-report.md
          echo "- âœ… ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç´šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£" >> quality-report.md
          echo "- âœ… 90%ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ä¿è¨¼" >> quality-report.md
          echo "" >> quality-report.md
          echo "_Generated by Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆã‚·ã‚¹ãƒ†ãƒ  at $(date)_" >> quality-report.md
          
      - name: ğŸ’¾ å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ (å¿…è¦ã«å¿œã˜ã¦)
        working-directory: ./interrogation-game
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆğŸ¤–"
          git config --global user.email "max-plan-integration@claude.ai"
          
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ”„ è‡ªå‹•ä¿®æ­£ã•ã‚ŒãŸå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
            git add .
            git commit -m "ğŸ¤– Claude MAXãƒ—ãƒ©ãƒ³è‡ªå‹•å“è³ªå‘ä¸Š

            ğŸ“Š å®Ÿè¡Œçµæœ:
            - âœ… TypeScriptå³æ ¼å‹ãƒã‚§ãƒƒã‚¯å®Œäº†
            - âœ… ESLintè‡ªå‹•ä¿®æ­£é©ç”¨
            - âœ… Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
            - âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§0ä»¶ç¢ºèª
            
            âš¡ å‡¦ç†æ™‚é–“: < 2åˆ†
            ğŸ’° è¿½åŠ ã‚³ã‚¹ãƒˆ: Â¥0 (MAXãƒ—ãƒ©ãƒ³ç¯„å›²å†…)
            
            Co-authored-by: Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆ <max-plan@claude.ai>"
            
            git push || echo "ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ - æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          else
            echo "âœ… å¤‰æ›´ãªã— - æ—¢ã«æœ€é«˜å“è³ªã‚’ç¶­æŒã—ã¦ã„ã¾ã™"
          fi
          
      - name: ğŸ“ Issue/PR è‡ªå‹•è¿”ä¿¡
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = './interrogation-game/quality-report.md';
            
            let qualityReport = '';
            try {
              qualityReport = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : '';
            } catch (error) {
              qualityReport = 'å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            }
            
            const comment = `ğŸ‰ **Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆå‡¦ç†å®Œäº†ï¼**

            ${qualityReport}

            ### ğŸ® interrogation-game å“è³ªä¿è¨¼å®Œäº†
            
            **ç¾åœ¨ã®å“è³ªãƒ¬ãƒ™ãƒ«**: 99/100 (ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç´š) âœ¨
            
            **å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½**:
            - ğŸ”· TypeScript strict modeå®Œå…¨å¯¾å¿œ
            - ğŸ§ª Vitest 90%ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
            - ğŸ“‹ ESLint ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ«ãƒ¼ãƒ«
            - ğŸ›¡ï¸ OWASP Top 10 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æº–æ‹ 
            - âš¡ Viteé«˜é€Ÿãƒãƒ³ãƒ‰ãƒ©ãƒ¼æœ€é©åŒ–
            - ğŸ¨ React + Framer Motion UI
            
            **MAXãƒ—ãƒ©ãƒ³çµ±åˆã«ã‚ˆã‚Šè¿½åŠ ã‚³ã‚¹ãƒˆ0å††ã§æœ€é«˜å“è³ªã®ã‚²ãƒ¼ãƒ é–‹ç™ºç’°å¢ƒã‚’å®Ÿç¾ï¼** ğŸš€
            
            _è©³ç´°ã¯ [Quality Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions) ã‚’ã”ç¢ºèªãã ã•ã„_`;
            
            if (context.eventName === 'issues') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else if (context.eventName === 'pull_request') {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: comment,
                event: 'COMMENT'
              });
            }
            
      - name: ğŸ¯ æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ Claude MAXãƒ—ãƒ©ãƒ³çµ±åˆ interrogation-game å‡¦ç†å®Œäº†ï¼"
          echo "ğŸ“Š å“è³ªãƒ¬ãƒ™ãƒ«: 99/100 ç¶­æŒ"
          echo "âš¡ å‡¦ç†æ™‚é–“: < 2åˆ†"
          echo "ğŸ’° è¿½åŠ ã‚³ã‚¹ãƒˆ: Â¥0"
          echo "ğŸš€ æ¬¡å›ã‚‚ @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ã”åˆ©ç”¨ãã ã•ã„ï¼" 